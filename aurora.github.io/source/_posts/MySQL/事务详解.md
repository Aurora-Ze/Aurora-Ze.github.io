---
title: 事务详解
categories: MySQL
---

# 一、什么是事务

### 事务定义如下：

> 访问并可能更新数据库中各项数据的一个**程序执行单元**

### 事务特性：

| 特性（ACID） | 描述                                                         |
| ------------ | ------------------------------------------------------------ |
| 原子性       | 事务内的操作要么全部完成，要么全部失败回滚                   |
| 一致性       | 依赖于开发者，来保证数据库在一个事务执行前后都处于正确状态   |
| 隔离性       | 并发事务之间相互隔离，察觉不到有其他事务在执行               |
| 持久性       | 事务一旦被提交，对数据的改变就是永久性的，即使故障也不会丢失改变的提交。 |

### 事务隔离级别

| 级别\问题（是否存在） | 脏读 | 不可重复读 |      幻读      |
| :-------------------: | :--: | :--------: | :------------: |
|       读未提交        |  是  |     是     |       是       |
|       读已提交        |  否  |     是     |       是       |
|       可重复读        |  否  |     否     | 是（MVCC时有） |
|        串行化         |  否  |     否     |       否       |

# 二、事务实现

上面介绍的四个特性中，隔离性由锁来实现；原子性、一致性和持久性通过数据库的`redo log`和`undo log`来完成。

## redo log

`redo log`是一种`物理格式`日志，记录了对页的修改；它实现了事务的持久性，由两部分组成：

- 内存中的`重做日志缓冲`(redo log buffer)
- 操作系统缓存中的`重做日志文件`(redo log file)

**注意，这里为什么是在操作系统中呢？因为打开日志文件时没有使用`O_DIRECT`标志位，所以不能绕过操作系统直接添加到磁盘中。**

所以从内存中更新数据到磁盘，经历了以下过程：

![img](https://raw.githubusercontent.com/Aurora-Ze/pictures/master/img/20210502235152.png)

可以看到，从操作系统缓冲写入到磁盘，需要进行`fsync()`操作；多久执行一次该操作，可以通过参数`innodb_flush_log_at_trx_commit`来决定。该参数有三个取值，分别是0，1，2。

| 参数 |                            描述                            |                             特点                             |
| :--: | :--------------------------------------------------------: | :----------------------------------------------------------: |
|  0   |           表示主线程每隔一秒执行一次**fsync()**            |           数据库或计算机宕机时，都会丢失一部分数据           |
|  1   |         表示事务每提交一次，就执行一次**fsync()**          |                      并发场景下性能较差                      |
|  2   | 表示事务提交时，把**重做日志缓冲**写入到**重做日志文件**中 | 数据库宕机不会影响，因为日志已经在操作系统缓冲区了；系统宕机时，会丢失一部分数据 |

下面我们介绍redo log的存储结构

### log block

在`innodb`存储引擎中，重做日志是以**块**（每块512字节）的方式存储的，重做日志缓冲和重做日志文件统称为重做日志块。

日志块结构如下，主要有三部分组成，`12`字节的头部，`8`字节的尾部和`492`字节的内容

<img src="https://raw.githubusercontent.com/Aurora-Ze/pictures/master/img/20210503001857.png" alt="image-20210503001857387" style="zoom:67%;" />

如果重做日志大于512字节，就需要多个日志块来存储。

此外，还有一些相关概念，如`log group`、`LSN`等就不再介绍，以后再补充。。。

## undo log

### 描述

`undo log`记录的是逻辑操作，具体地说，应该是事务中每步操作的`逆向操作`

例如，事务中执行了一条插入语句，那么`undo log`就会记录一次删除。

### 特点

- 回滚

  在事务失败时，可以根据它回滚到事务开始前的状态。

- 多版本控制

  在MVCC中，如果数据被其它事务占用，就可以根据`undo log`来获取之前版本的数据，避免阻塞地获取锁。

### 3种操作的undo log

#### insert

因为事务隔离性的要求，插入数据只对当前事务可见，其他事务不应该发现。

所以它产生的undo log可以在事务提交后直接删除

#### delete

先执行逻辑删除，把标志位设置成删除，然后等待purge线程进行物理删除

#### update

这里分两类讨论

- 不更新主键

  直接更新即可，并生成undo log

- 更新主键

  先标记删除原有主键的记录，再执行插入。